<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BrainQuest</title>
  <style>
    :root { --bg:#2d0159; --card:#243b55; --card-2:#3b2e4f; --accent:orange; --text:#fff; --green:#00C49F; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);text-align:center}
    h1,h2,h3{margin:.4rem 0}
    .container{max-width:980px;margin:0 auto;padding:24px 16px}

    /* Buttons / inputs */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;background:var(--accent);color:#2d0159;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#eee;color:#333}
    input{width:100%;padding:12px;border:none;border-radius:10px;background:var(--card-2);color:#fff;margin:.5rem 0}
    a{color:var(--accent);text-decoration:none}

    /* Sections */
    section{display:none}
    section.active{display:block}

    /* Subject buttons */
    .row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .subject{min-width:240px;text-align:left;background:var(--card);color:#fff}
    .subject:hover{background:var(--card-2)}

    /* Quiz UI */
    #question{font-size:18px;font-weight:700;margin:10px auto 18px;width:90%;max-width:680px;line-height:1.35}
    .option{width:90%;max-width:600px;margin:10px auto;padding:12px 14px;background:var(--card);border-radius:12px;cursor:pointer;transition:background .25s;user-select:none}
    .option:hover{background:var(--card-2)}
    .option.correct{background:#0a8f3d !important}
    .option.wrong{background:#b00020 !important}
    .bar{height:10px;width:100%;max-width:480px;margin:8px auto;background:var(--card-2);border-radius:8px;overflow:hidden}
    .bar>div{height:100%;width:0%;background:var(--accent);transition:width .35s}
    .stats{margin:.5rem 0 .25rem;font-size:14px;opacity:.9}
    #welcome-banner{margin:.5rem 0 1rem;font-weight:700}
    #welcome-banner .name{color:var(--green);font-weight:900}
    .top-actions{display:flex;gap:10px;justify-content:center;margin-top:10px}

    /* Last 5 results */
    #results-panel{margin:18px auto 0;max-width:940px;text-align:left}
    #results-panel h3{margin:0 0 10px}
    .results-box{background:#243b55;border-radius:14px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15);font-size:14px}
    th{text-align:left;background:transparent;color:#fff;opacity:.9}
    tr:hover{background:rgba(255,255,255,.06);cursor:pointer}
    .muted{opacity:.8}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{background:#243b55;border-radius:14px;max-width:820px;width:100%;max-height:80vh;overflow:auto;position:relative;padding:16px 16px 10px}
    .modal .close{position:absolute;top:8px;right:10px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;line-height:1}
    .qrow{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
    .qrow .q{font-weight:700;margin-bottom:6px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f3b5f;font-size:12px;margin-left:6px}

    /* ======= Compact auth card style ======= */
    #auth .shell{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
    #auth .card-auth{width:92%;max-width:360px;background:rgba(255,255,255,.06);border-radius:14px;padding:22px 18px;box-shadow:0 8px 24px rgba(0,0,0,.35);text-align:center}
    #brand{font-weight:900;font-size:26px;letter-spacing:.3px;margin:6px 0 14px}
    #auth .subtitle{opacity:.9;margin:-6px 0 16px}
    .splitter{margin:12px 0;border-top:1px solid rgba(255,255,255,.15)}
    .google-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#fff;color:#111;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;border:none;width:100%}
    .tiny{font-size:12px;opacity:.85}

    /* ======= Celebration Overlay ======= */
    #celebrate{
      position:fixed; inset:0; display:none; place-items:center; z-index:10000;
      background: radial-gradient(1200px 600px at 50% -20%, rgba(255,255,255,.08), transparent 40%),
                  radial-gradient(800px 400px at 10% 110%, rgba(255,255,255,.06), transparent 40%);
    }
    #fx-canvas{position:absolute; inset:0; width:100%; height:100%}
    .cele-content{
      position:relative; text-align:center; padding:18px 22px; max-width:90%;
      background:rgba(36,59,85,.35); border:1px solid rgba(255,255,255,.15);
      border-radius:16px; backdrop-filter: blur(6px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      animation: popin .6s cubic-bezier(.2,.8,.2,1);
    }
    .cele-name{
      font-size: clamp(28px, 5vw, 54px);
      font-weight:900; letter-spacing:.4px; margin:0 0 6px;
      text-shadow:0 4px 22px rgba(0,0,0,.6);
      background:linear-gradient(90deg, #fff, #ffd166, #fff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: shimmer 2.5s linear infinite;
    }
    .cele-line{
      font-size: clamp(16px, 3.2vw, 22px);
      margin:0 0 6px; opacity:.95;
    }
    .cele-quote{
      font-size: clamp(14px, 2.8vw, 18px);
      opacity:.9; margin:6px 0 0;
    }
    @keyframes popin{
      0%{transform:translateY(10px) scale(.96); opacity:0}
      100%{transform:translateY(0) scale(1); opacity:1}
    }
    @keyframes shimmer{
      0%{background-position:0% 50%}
      100%{background-position:200% 50%}
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- ======= AUTH (single card) ======= -->
    <section id="auth" class="active">
      <div class="shell">
        <div class="card-auth">
          <div id="brand">BrainQuest</div>
          <div class="subtitle">Sign in to start your quizzes</div>

          <!-- Login -->
          <input id="login-id" placeholder="Email or Mobile*" />
          <input id="login-pass" type="password" placeholder="Password*" />
          <button class="btn" id="login-btn" style="width:100%">Log In</button>

          <div class="splitter"></div>

          <!-- Google Sign-In -->
          <button class="google-btn" id="google-btn" aria-label="Sign in with Google">
            <span>üîë</span> Sign in with Google
          </button>

          <div class="splitter"></div>

          <!-- Signup (inside same card) -->
          <div class="tiny" style="margin-bottom:6px">Don't have an account? Create one:</div>
          <input id="signup-name" placeholder="Full Name*" />
          <input id="signup-id" placeholder="Email or Mobile*" />
          <input id="signup-pass" type="password" placeholder="Password (min 6)*" />
          <button class="btn" id="signup-btn" style="width:100%">Sign Up</button>

          <p id="auth-msg" style="min-height:22px;margin:.6rem 0 0;color:#ffd966"></p>
        </div>
      </div>
    </section>

    <!-- ======= SUBJECTS ======= -->
    <section id="subjects">
      <h2 id="hello"></h2>
      <p>Select a subject to begin:</p>
      <div class="row" id="subject-list"></div>
      <div class="top-actions">
        <button class="btn secondary" id="logout-1">Logout</button>
      </div>
    </section>

    <!-- ======= QUIZ ======= -->
    <section id="quiz">
      <h2 id="welcome-banner"></h2>
      <div class="stats" id="stats">‚úÖ Correct: 0 &nbsp; | &nbsp; ‚ùå Incorrect: 0</div>
      <div id="qprogress" class="muted">Question 1/1</div>
      <div class="bar"><div id="bar-inner"></div></div>

      <div class="card" style="background:#243b55;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)">
        <div id="question">Loading‚Ä¶</div>
        <div id="options"></div>
      </div>

      <div id="end-screen" style="display:none;margin-top:14px"></div>

      <!-- Last 5 results panel -->
      <div id="results-panel">
        <h3>Last 5 Results</h3>
        <div class="results-box">
          <table>
            <thead>
              <tr>
                <th style="width:20%">Date & Time</th>
                <th style="width:20%">Subject</th>
                <th style="width:12%">Correct</th>
                <th style="width:14%">Incorrect</th>
                <th style="width:14%">Total</th>
                <th style="width:20%">Time Taken</th>
              </tr>
            </thead>
            <tbody id="last5-body">
              <tr><td class="muted" colspan="6">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="top-actions" style="margin-top:14px">
        <button class="btn secondary" id="back-to-subjects">Choose another subject</button>
        <button class="btn secondary" id="logout-2">Logout</button>
      </div>

      <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
      <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>
    </section>
  </div>

  <!-- ======= MODAL (result details) ======= -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <button class="close" id="modal-close" aria-label="Close">‚úï</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- ======= CELEBRATION OVERLAY ======= -->
  <div id="celebrate">
    <canvas id="fx-canvas"></canvas>
    <div class="cele-content" id="cele-content">
      <div class="cele-name" id="cele-name">Great job!</div>
      <div class="cele-line" id="cele-line"></div>
      <div class="cele-quote" id="cele-quote"></div>
    </div>
  </div>

  <!-- ================== APP ================== -->
  <script type="module">
    /* ---------- Firebase SDK (v12) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, updateProfile, signOut,
      GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc,
      collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ---------- Config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBWTOgHmlJmCtpb2LQ7g3wj_IMsTwyTNDE",
      authDomain: "quizzy-ea14d.firebaseapp.com",
      projectId: "quizzy-ea14d",
      storageBucket: "quizzy-ea14d.appspot.com",
      messagingSenderId: "452576898646",
      appId: "1:452576898646:web:9fa8dbc2e106bcce8615f7",
      measurementId: "G-VKNVF4YZCB"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    /* ---------- Helpers ---------- */
    const $ = (id) => document.getElementById(id);
    function show(id){ document.querySelectorAll('section').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
    function msg(text){ $("auth-msg").textContent = text || ""; }

    const SUBJECTS = [
      { key:"science", label:"Science",          file:"questions.json" },
      { key:"sst",     label:"Social Studies",   file:"questions_sst.json" },
      { key:"eng",     label:"English",          file:"questions_eng.json" },
      { key:"math",    label:"Mathematics",      file:"questions_math.json" },
      { key:"cs",      label:"Computer Science", file:"questions_cs.json" }
    ];
    const GITHUB_BASE = "https://singla1209.github.io/Quiz_App/";

    /* ---------- State ---------- */
    let userName = "";
    let userId   = null;
    let subject  = null;
    let questions = [];
    let idx = 0, correct = 0, incorrect = 0, responses = [];
    let quizStartMs = null;

    /* Build subject buttons */
    const list = $("subject-list");
    SUBJECTS.forEach(s => {
      const btn = document.createElement("button");
      btn.className = "btn subject";
      btn.textContent = s.label;
      btn.onclick = () => startSubject(s);
      list.appendChild(btn);
    });

    /* ---------- Auth ---------- */
    $("login-btn").onclick = async () => {
      msg();
      let id = $("login-id").value.trim();
      const pass = $("login-pass").value;
      if(!id || !pass){ msg("Enter email/mobile and password."); return; }
      if(!id.includes("@")) id += "@mobile.com";
      try { await signInWithEmailAndPassword(auth, id, pass); }
      catch(e){ msg(humanAuthError(e)); }
    };

    $("google-btn").onclick = async () => {
      msg();
      try {
        const cred = await signInWithPopup(auth, googleProvider);
        await setDoc(doc(db, "users", cred.user.uid), {
          name: cred.user.displayName || "",
          emailOrMobile: cred.user.email || "",
          createdAt: serverTimestamp()
        }, { merge:true });
      } catch(e){ msg(humanAuthError(e)); }
    };

    $("signup-btn").onclick = async () => {
      msg();
      const name = $("signup-name").value.trim();
      let id = $("signup-id").value.trim();
      const pass = $("signup-pass").value;
      if(!name || !id || !pass){ msg("Fill all sign up fields."); return; }
      const rawId = id;
      if(!id.includes("@")) id += "@mobile.com";
      try {
        const cred = await createUserWithEmailAndPassword(auth, id, pass);
        await updateProfile(cred.user, { displayName: name });
        await setDoc(doc(db, "users", cred.user.uid), {
          name, emailOrMobile: rawId, createdAt: serverTimestamp()
        }, { merge:true });
      } catch(e){ msg(humanAuthError(e)); }
    };

    $("logout-1").onclick = () => signOut(auth);
    $("logout-2").onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if(user){
        userId = user.uid;
        userName = user.displayName || "";
        if(!userName){
          const snap = await getDoc(doc(db,"users",user.uid));
          userName = (snap.exists() && snap.data().name) ? snap.data().name : (user.email || "User");
        }
        $("hello").textContent = `Hi ${userName}!`;
        show("subjects");
      }else{
        userId = null;
        $("login-pass").value = "";
        $("signup-pass").value = "";
        show("auth");
      }
    });

    /* ---------- Quiz flow ---------- */
    async function startSubject(s){
      if(!auth.currentUser){ show("auth"); return; } // guard
      subject = s;
      idx = 0; correct = 0; incorrect = 0; responses = [];
      quizStartMs = null;
      $("stats").textContent = `‚úÖ Correct: 0  |  ‚ùå Incorrect: 0`;
      $("qprogress").textContent = `Question 1/1`;
      $("bar-inner").style.width = "0%";
      $("end-screen").style.display = "none";
      $("welcome-banner").innerHTML = `Welcome <span class="name">${userName}</span> in BrainQuest of <b>${s.label}</b>`;
      show("quiz");

      try{
        const res = await fetch(GITHUB_BASE + s.file, {cache:"no-store"});
        questions = await res.json();
      }catch(e){ questions = []; }

      if(!questions || !questions.length){
        $("question").textContent = "Could not load questions.";
        $("options").innerHTML = "";
        fetchLastFive();
        return;
      }
      renderQuestion();
      fetchLastFive();
    }

    function renderQuestion(){
      const q = questions[idx];
      $("question").textContent = `Q${idx+1}. ${q.question}`;
      const optionsDiv = $("options");
      optionsDiv.innerHTML = "";
      for(const key in q.options){
        const div = document.createElement("div");
        div.className = "option";
        div.textContent = `${key}: ${q.options[key]}`;
        div.onclick = () => choose(key, div);
        optionsDiv.appendChild(div);
      }
      $("qprogress").textContent = `Question ${idx+1}/${questions.length}`;
      $("bar-inner").style.width = `${((idx)/questions.length)*100}%`;
      if(quizStartMs === null) quizStartMs = Date.now();
    }

    function choose(selectedKey, el){
      document.querySelectorAll(".option").forEach(o => o.style.pointerEvents = "none");
      const q = questions[idx];
      const correctKey = q.correct;

      document.querySelectorAll(".option").forEach(o=>{
        const isCorrect = o.textContent.startsWith(correctKey + ":");
        if(isCorrect) o.classList.add("correct");
      });
      if(!el.textContent.startsWith(correctKey + ":")) el.classList.add("wrong");

      const selectedAnswer = q.options[selectedKey];
      const correctAnswer  = q.options[correctKey];
      responses.push({ question: q.question, selected: selectedAnswer || "No answer", correct: correctAnswer });

      if(selectedKey === correctKey){ correct++; $("correct-sound").play(); }
      else { incorrect++; $("wrong-sound").play(); }

      $("stats").textContent = `‚úÖ Correct: ${correct}  |  ‚ùå Incorrect: ${incorrect}`;
      $("bar-inner").style.width = `${((idx+1)/questions.length)*100}%`;

      setTimeout(()=>{
        if(idx < questions.length-1){ idx++; renderQuestion(); }
        else { finishQuiz(); }
      }, 900);
    }

    function secsToText(s){
      s = Math.max(0, Math.round(s));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}m ${r}s`;
    }
    function toMillis(df){
      if(!df) return 0;
      if(typeof df.toDate === "function") return df.toDate().getTime();
      return new Date(df).getTime() || 0;
    }

    async function finishQuiz(){
      $("question").textContent = "All done!";
      $("options").innerHTML = "";
      $("end-screen").style.display = "block";
      $("end-screen").innerHTML = `
        <h3>Score: ${correct} / ${questions.length}</h3>
        <button class="btn" onclick="location.reload()">Play Again</button>
      `;

      const timeTakenSec = quizStartMs ? (Date.now() - quizStartMs)/1000 : 0;
      const current = auth.currentUser;

      try{
        await addDoc(collection(db, "quiz_results"), {
          name: (userName || current?.displayName || ""),
          score: correct,
          totalQuestions: questions.length,
          correctAnswers: correct,
          incorrectAnswers: questions.length - correct,
          responses: responses,
          date: serverTimestamp(),
          subject: subject ? subject.label : null,
          userId: current ? current.uid : null,
          userEmail: current ? current.email : null,
          timeTakenSec: Math.round(timeTakenSec)
        });
        fetchLastFive();
      }catch(e){
        console.error("Save failed:", e);
      }

      // ===== Celebration (score-based) =====
      const pct = (questions.length > 0) ? (correct / questions.length) * 100 : 0;
      runCelebration({
        userName: userName || "Great job!",
        percentage: pct
      });
    }

    /* ---------- Last 5 results ---------- */
    async function fetchLastFive(){
      const body = $("last5-body");
      body.innerHTML = `<tr><td class="muted" colspan="6">Loading‚Ä¶</td></tr>`;
      try{
        const snap = await getDocs(query(
          collection(db, "quiz_results"),
          orderBy("date","desc"),
          limit(50)
        ));

        const current = auth.currentUser;
        const email = current?.email || null;
        const list = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const match =
            (d.userId && userId && d.userId === userId) ||
            (d.userEmail && email && d.userEmail === email) ||
            (d.name && userName && String(d.name).trim().toLowerCase() === String(userName).trim().toLowerCase());
          if(match) list.push(d);
        });

        if(!list.length){
          body.innerHTML = `<tr><td class="muted" colspan="6">No results yet. Finish a quiz to see it here.</td></tr>`;
          return;
        }

        list.sort((a,b)=> toMillis(b.date) - toMillis(a.date));
        const top5 = list.slice(0,5);

        body.innerHTML = "";
        top5.forEach(d=>{
          const dt = d.date?.toDate ? d.date.toDate() : (d.date ? new Date(d.date) : null);
          const dtTxt = dt ? dt.toLocaleString() : "";
          const total = Number(d.totalQuestions)||0;
          const corr  = Number(d.correctAnswers)||0;
          const inc   = Number(d.incorrectAnswers) || Math.max(0,total-corr);
          const secs  = Number(d.timeTakenSec)||0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${dtTxt}</td>
            <td>${d.subject||"N/A"}</td>
            <td>${corr}</td>
            <td>${inc}</td>
            <td>${total}</td>
            <td>${secsToText(secs)}</td>
          `;
          tr.onclick = ()=> openModalForResult(d);
          body.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        body.innerHTML = `<tr><td class="muted" colspan="6">Couldn't load results.</td></tr>`;
      }
    }

    /* ---------- Modal helpers ---------- */
    function openModalForResult(data){
      const content = $("modal-content");
      const dt = data.date?.toDate ? data.date.toDate().toLocaleString() :
                 (data.date ? new Date(data.date).toLocaleString() : "");
      const total = Number(data.totalQuestions)||0;
      const corr  = Number(data.correctAnswers)||0;
      const secs  = Number(data.timeTakenSec)||0;

      let html = `
        <h3 style="margin:0 24px 6px 6px;text-align:left">
          ${data.subject || "Result"} 
          <span class="tag">${dt}</span>
        </h3>
        <p class="muted" style="text-align:left;margin:0 0 10px 6px">
          Score: <b>${corr}/${total}</b> &nbsp; ‚Ä¢ &nbsp; Time: <b>${secsToText(secs)}</b>
        </p>
      `;

      if(Array.isArray(data.responses) && data.responses.length){
        data.responses.forEach((r,i)=>{
          html += `
            <div class="qrow">
              <div class="q">Q${i+1}. ${r.question || ""}</div>
              <div>Attempted: <b>${r.selected || ""}</b></div>
              <div>Correct: <b>${r.correct || ""}</b></div>
            </div>
          `;
        });
      }else{
        html += `<div class="qrow">No response details saved.</div>`;
      }

      content.innerHTML = html;
      $("modal-overlay").style.display = "flex";
    }
    $("modal-close").onclick = ()=> $("modal-overlay").style.display = "none";
    $("modal-overlay").addEventListener("click", (e)=>{
      if(e.target.id === "modal-overlay") $("modal-overlay").style.display = "none";
    });

    /* ---------- Errors ---------- */
    function humanAuthError(e){
      const code = (e && e.code) ? e.code : "";
      switch(code){
        case "auth/invalid-email": return "Please enter a valid email.";
        case "auth/missing-password": return "Please enter your password.";
        case "auth/invalid-credential":
        case "auth/wrong-password":
        case "auth/user-not-found": return "Invalid email/mobile or password.";
        case "auth/cancelled-popup-request":
        case "auth/popup-closed-by-user": return "Google sign-in was closed. Try again.";
        case "auth/email-already-in-use": return "This email/mobile is already registered. Try logging in.";
        case "auth/weak-password": return "Password should be at least 6 characters.";
        default: return e.message || "Authentication error.";
      }
    }

    /* ---------- Celebration Engine (Canvas-based) ---------- */
    const MOTIVATION_LOW = [
      "Nice try‚Äîkeep going!",
      "Every step builds strength.",
      "You‚Äôre learning fast‚Äîdon‚Äôt stop!",
      "Progress over perfection.",
      "Good start‚Äînext round is yours!"
    ];
    const MOTIVATION_MID = [
      "Solid performance‚Äîwell done!",
      "You‚Äôre on the right track!",
      "Great momentum‚Äîkeep it up!",
      "Strong effort and it shows!",
      "Nice work‚Äîconfidence rising!"
    ];
    const MOTIVATION_HIGH = [
      "Outstanding! You crushed it!",
      "Brilliant work‚Äîtop tier!",
      "That‚Äôs excellence in action!",
      "Phenomenal score‚Äîlegend move!",
      "Gold star performance‚Äîamazing!"
    ];

    function runCelebration({ userName, percentage }){
      const overlay = $("celebrate");
      const canvas = $("fx-canvas");
      const ctx = canvas.getContext("2d");
      const nameEl = $("cele-name");
      const lineEl = $("cele-line");
      const quoteEl = $("cele-quote");

      // Set messages by tier
      let tier = "low";
      let confettiCount = 80, gravity = 0.25, fireworks = false, ribbons = false, duration = 4500;
      if(percentage > 80){
        tier = "high";
        confettiCount = 260; gravity = 0.35; fireworks = true; ribbons = true; duration = 6500;
      } else if(percentage > 50){
        tier = "mid";
        confettiCount = 150; gravity = 0.30; fireworks = true; ribbons = true; duration = 5500;
      }
      const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
      const lineText = (tier==="high") ? "Exceptional job!" : (tier==="mid") ? "Great job!" : "Nice effort!";
      const quoteText = (tier==="high") ? pick(MOTIVATION_HIGH) : (tier==="mid") ? pick(MOTIVATION_MID) : pick(MOTIVATION_LOW);

      nameEl.textContent = (userName || "Great job!") + " üéâ";
      lineEl.textContent = lineText;
      quoteEl.textContent = quoteText;

      // Show overlay
      overlay.style.display = "grid";

      // Canvas sizing
      function resize(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resize();
      window.addEventListener("resize", resize);

      // Particle system
      const colors = ["#FFD166","#06D6A0","#118AB2","#EF476F","#FFFFFF","#FFA500"];
      const particles = [];
      const ribbonsArr = [];

      function spawnConfetti(n){
        for(let i=0;i<n;i++){
          particles.push({
            x: Math.random()*canvas.width,
            y: -20 - Math.random()*100,
            vx: (Math.random()*2-1)*3,
            vy: Math.random()*-2,
            size: 6 + Math.random()*6,
            color: colors[(Math.random()*colors.length)|0],
            life: 200 + Math.random()*80,
            rotation: Math.random()*Math.PI*2,
            vr: (Math.random()-.5)*0.2,
            shape: (Math.random() < .25) ? "circle" : "rect"
          });
        }
      }
      function spawnRibbons(n){
        for(let i=0;i<n;i++){
          ribbonsArr.push({
            x: Math.random()*canvas.width,
            y: -40 - Math.random()*200,
            vx: (Math.random()*2-1)*1.2,
            vy: 1 + Math.random()*1.2,
            hue: Math.random()*360,
            w: 60 + Math.random()*80,
            h: 10 + Math.random()*8,
            t: Math.random()*Math.PI*2
          });
        }
      }
      function spawnFirework(){
        const cx = canvas.width* (0.2 + Math.random()*0.6);
        const cy = canvas.height* (0.25 + Math.random()*0.4);
        const count = 36 + (Math.random()*24|0);
        for(let i=0;i<count;i++){
          const ang = (Math.PI*2) * (i/count);
          const speed = 2.5 + Math.random()*2.5;
          particles.push({
            x: cx, y: cy,
            vx: Math.cos(ang)*speed,
            vy: Math.sin(ang)*speed,
            size: 3 + Math.random()*3,
            color: colors[(Math.random()*colors.length)|0],
            life: 120 + Math.random()*80,
            rotation: Math.random()*Math.PI*2,
            vr: (Math.random()-.5)*0.2,
            shape: "circle"
          });
        }
      }

      // Initial spawns
      spawnConfetti(confettiCount);
      if(ribbons) spawnRibbons(16);
      if(fireworks) {
        setTimeout(spawnFirework, 700);
        setTimeout(spawnFirework, 1400);
        if(percentage > 80) setTimeout(spawnFirework, 2100);
      }

      let running = true;
      const start = performance.now();

      function draw(){
        if(!running) return;
        const now = performance.now();
        const elapsed = now - start;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // Gradients backdrop subtle
        // Confetti
        for(let i=particles.length-1;i>=0;i--){
          const p = particles[i];
          p.vy += gravity*0.06; // gentle integration
          p.x += p.vx;
          p.y += p.vy;
          p.rotation += p.vr;
          p.life -= 1;

          if(p.shape === "rect"){
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            ctx.restore();
          }else{
            ctx.beginPath();
            ctx.arc(p.x,p.y,p.size*0.45,0,Math.PI*2);
            ctx.fillStyle = p.color;
            ctx.fill();
          }
          if(p.y > canvas.height+40 || p.life<=0) particles.splice(i,1);
        }

        // Ribbons
        for(let i=ribbonsArr.length-1;i>=0;i--){
          const r = ribbonsArr[i];
          r.t += 0.08;
          r.x += r.vx + Math.sin(r.t)*0.8;
          r.y += r.vy;
          ctx.save();
          ctx.translate(r.x, r.y);
          ctx.rotate(Math.sin(r.t)*0.6);
          const grd = ctx.createLinearGradient(-r.w/2,0,r.w/2,0);
          grd.addColorStop(0, `hsl(${r.hue}, 90%, 60%)`);
          grd.addColorStop(1, `hsl(${(r.hue+60)%360}, 90%, 50%)`);
          ctx.fillStyle = grd;
          ctx.fillRect(-r.w/2, -r.h/2, r.w, r.h);
          ctx.restore();
          if(r.y > canvas.height+60) ribbonsArr.splice(i,1);
        }

        // Keep sprinkling a few more confetti while active (smooth tail)
        if(elapsed < duration){
          if(Math.random() < 0.6) spawnConfetti(2);
        }

        if(elapsed >= duration && particles.length === 0 && ribbonsArr.length === 0){
          stopCelebration(); return;
        }
        requestAnimationFrame(draw);
      }

      function stopCelebration(){
        running = false;
        overlay.style.display = "none";
        window.removeEventListener("resize", resize);
      }

      // Close on click / tap
      overlay.addEventListener("click", stopCelebration, { once:true });

      requestAnimationFrame(draw);
    }
  </script>
</body>
</html>
