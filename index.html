<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BrainQuest</title>
  <style>
    :root { --bg:#2d0159; --card:#243b55; --card-2:#3b2e4f; --accent:orange; --text:#fff; --green:#00C49F; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);}
    h1,h2,h3{margin:.4rem 0}

    /* ===== App layout ===== */
    .container{min-height:100vh;display:flex;flex-direction:column}
    main{flex:1;display:flex;padding:20px}

    /* IMPORTANT: show one screen at a time */
    section{display:none;width:100%;flex:0 0 100%;opacity:0;transition:opacity .3s ease}
    section.active{display:flex;align-items:center;justify-content:center;opacity:1}

    /* Buttons / inputs */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;background:var(--accent);color:#2d0159;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#eee;color:#333}
    input{width:100%;padding:12px;border:none;border-radius:10px;background:var(--card-2);color:#fff;margin:.5rem 0}
    a{color:var(--accent);text-decoration:none}

    /* Subject selection: centered card + responsive grid */
    #subjects > div, #chapters > div {
      width: 100%;
      max-width: 980px;
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 22px 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      text-align: center;
    }
    #subject-list, #chapter-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    @media (min-width: 520px){
      #subject-list, #chapter-list { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (min-width: 900px){
      #subject-list, #chapter-list { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    .subject, .chapter{background:var(--card);color:#fff;padding:12px;border-radius:12px;cursor:pointer;text-align:center}
    .subject:hover, .chapter:hover{background:var(--card-2)}

    /* Quiz UI */
    #quiz-wrapper{width:100%;max-width:980px;margin:0 auto}
    #question{font-size:18px;font-weight:700;margin:10px auto 18px;width:90%;max-width:680px;line-height:1.35;text-align:center}
    .option{width:90%;max-width:600px;margin:10px auto;padding:12px 14px;background:var(--card);border-radius:12px;cursor:pointer;transition:background .25s;user-select:none}
    .option:hover{background:var(--card-2)}
    .option.correct{background:#0a8f3d !important}
    .option.wrong{background:#b00020 !important}
    .bar{height:10px;width:100%;max-width:480px;margin:8px auto;background:var(--card-2);border-radius:8px;overflow:hidden}
    .bar>div{height:100%;width:0%;background:var(--accent);transition:width .35s}
    .stats{margin:.5rem 0 .25rem;font-size:14px;opacity:.9;text-align:center}
    #welcome-banner{margin:.5rem 0 1rem;font-weight:700;text-align:center}
    #welcome-banner .name{color:var(--green);font-weight:900}
    .top-actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}

    /* Last 5 results */
    #results-panel{margin:18px auto 0;max-width:940px;text-align:left;width:100%}
    #results-panel h3{margin:0 0 10px}
    .results-box{background:#243b55;border-radius:14px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,.25);overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:680px}
    th, td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15);font-size:14px}
    th{text-align:left;background:transparent;color:#fff;opacity:.9}
    tr:hover{background:rgba(255,255,255,.06);cursor:pointer}
    .muted{opacity:.8}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
    .modal{background:#243b55;border-radius:14px;max-width:820px;width:100%;max-height:80vh;overflow:auto;position:relative;padding:16px 16px 10px}
    .modal .close{position:absolute;top:8px;right:10px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;line-height:1}
    .qrow{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
    .qrow .q{font-weight:700;margin-bottom:6px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f3b5f;font-size:12px;margin-left:6px}

    /* AUTH */
    #auth .shell{display:flex;align-items:center;justify-content:center;min-height:80vh;padding:24px;width:100%}
    #auth .card-auth{width:92%;max-width:360px;background:rgba(255,255,255,.06);border-radius:14px;padding:22px 18px;box-shadow:0 8px 24px rgba(0,0,0,.35);text-align:center}
    #brand{font-weight:900;font-size:26px;letter-spacing:.3px;margin:6px 0 14px}
    #auth .subtitle{opacity:.9;margin:-6px 0 16px}
    .splitter{margin:12px 0;border-top:1px solid rgba(255,255,255,.15)}
    .tiny{font-size:12px;opacity:.85}

    /* Google button */
    .google-btn{
      width:100%;border:1px solid rgba(255,255,255,.2);border-radius:10px;background:#fff;color:#111;
      display:flex;align-items:center;justify-content:center;gap:10px;font-weight:700;cursor:pointer;padding:10px 12px;
    }
    .google-btn svg{width:18px;height:18px}

    /* Quiz card */
    .quiz-card{background:#243b55;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}

    /* Celebration overlay */
    #celebrate-overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;
      z-index:50;pointer-events:none;
    }
    #confetti{position:fixed;inset:0;z-index:49;pointer-events:none}
    #celebrate-card{
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.2);
      border-radius:16px;
      padding:18px 16px;
      text-align:center;
      max-width:520px;width:92%;
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    #big-name{
      font-size:28px;font-weight:900;letter-spacing:.4px;color:#00e6b0;margin:6px 0 10px;
      animation: pop 800ms ease forwards;
    }
    #motivation{font-size:18px;margin:6px 0 12px}
    #donut{width:180px;height:180px;margin:10px auto 16px;display:block}
    @keyframes pop {
      0%{transform:scale(.6);opacity:0}
      60%{transform:scale(1.1);opacity:1}
      100%{transform:scale(1)}
    }
  </style>
</head>
<body>
  <div class="container">
    <main>
      <!-- ======= AUTH ======= -->
      <section id="auth" class="active">
        <div class="shell">
          <div class="card-auth">
            <div id="brand">BrainQuest</div>
            <div class="subtitle">Sign in to start your quizzes</div>

            <!-- Login -->
            <input id="login-id" placeholder="Email or Mobile*" />
            <input id="login-pass" type="password" placeholder="Password*" />
            <button class="btn" id="login-btn" style="width:100%">Log In</button>

            <div class="splitter"></div>

            <!-- Google Sign-In -->
            <button class="google-btn" id="google-btn" aria-label="Sign in with Google">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.8 31.7 29.4 35 24 35c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.9 5.1 29.7 3 24 3 12.4 3 3 12.4 3 24s9.4 21 21 21c10.5 0 19.2-7.6 20.6-17.5.3-1.5.4-3 .4-4.5 0-1.5-.1-3-.4-4.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.9C14.7 16.1 19 13 24 13c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.9 5.1 29.7 3 24 3 16.1 3 9.2 7.3 6.3 14.7z"/><path fill="#4CAF50" d="M24 45c5.2 0 9.9-2 13.4-5.2l-6.2-5.1C29.2 36.2 26.8 37 24 37c-5.3 0-9.8-3.4-11.5-8.1l-6.6 5.1C9 41 15.9 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3C34.7 31.7 29.4 35 24 35v10c10.5 0 19.2-7.6 20.6-17.5.3-1.5.4-3 .4-4.5z"/></svg>
              Sign in with Google
            </button>

            <div class="splitter"></div>

            <!-- Signup -->
            <div class="tiny" style="margin-bottom:6px">Don't have an account? Create one:</div>
            <input id="signup-name" placeholder="Full Name*" />
            <input id="signup-id" placeholder="Email or Mobile*" />
            <input id="signup-pass" type="password" placeholder="Password (min 6)*" />
            <button class="btn" id="signup-btn" style="width:100%">Sign Up</button>

            <p id="auth-msg" style="min-height:22px;margin:.6rem 0 0;color:#ffd966"></p>
          </div>
        </div>
      </section>

      <!-- ======= SUBJECTS ======= -->
      <section id="subjects">
        <div>
          <h2 id="hello"></h2>
          <p>Select a subject to begin:</p>
          <div id="subject-list"></div>
          <div class="top-actions">
            <button class="btn secondary" id="logout-1">Logout</button>
          </div>
        </div>
      </section>

      <!-- ======= CHAPTERS (for dynamic subjects) ======= -->
      <section id="chapters">
        <div>
          <h2 id="chapters-title">Choose a chapter</h2>
          <p id="chapters-subtitle" class="muted">NCERT Class 10 • Session 2025–26</p>
          <div id="chapter-list"></div>
          <div class="top-actions">
            <button class="btn secondary" id="back-to-subjects-2">Back to subjects</button>
          </div>
        </div>
      </section>

      <!-- ======= QUIZ ======= -->
      <section id="quiz">
        <div id="quiz-wrapper">
          <h2 id="welcome-banner"></h2>
          <div class="stats" id="stats">✅ Correct: 0 &nbsp; | &nbsp; ❌ Incorrect: 0</div>
          <div id="qprogress" class="muted" style="text-align:center">Question 1/1</div>
          <div class="bar"><div id="bar-inner"></div></div>

          <div class="quiz-card">
            <div id="question">Loading…</div>
            <div id="options"></div>
          </div>

          <div id="end-screen" style="display:none;margin-top:14px;text-align:center"></div>

          <!-- Last 5 results panel -->
          <div id="results-panel">
            <h3>Last 5 Results</h3>
            <div class="results-box">
              <table>
                <thead>
                  <tr>
                    <th style="width:19%">Date & Time</th>
                    <th style="width:21%">Subject</th>
                    <th style="width:20%">Name</th>
                    <th style="width:10%">Correct</th>
                    <th style="width:10%">Incorrect</th>
                    <th style="width:20%">Time Taken</th>
                  </tr>
                </thead>
                <tbody id="last5-body">
                  <tr><td class="muted" colspan="6">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="top-actions" style="margin-top:14px">
            <button class="btn secondary" id="back-to-subjects">Choose another subject</button>
            <button class="btn secondary" id="logout-2">Logout</button>
          </div>

          <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
          <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>
        </div>
      </section>
    </main>
  </div>

  <!-- ======= Celebration overlay + canvas ======= -->
  <canvas id="confetti"></canvas>
  <div id="celebrate-overlay" aria-hidden="true">
    <div id="celebrate-card">
      <div id="big-name"></div>
      <div id="motivation"></div>
      <canvas id="donut" width="180" height="180"></canvas>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
        <button class="btn" id="play-again-btn">Play Again</button>
        <button class="btn secondary" id="celebrate-close">Close</button>
      </div>
    </div>
  </div>

  <!-- ======= MODAL (result details) ======= -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <button class="close" id="modal-close" aria-label="Close">✕</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- ================== APP ================== -->
  <script type="module">
    /* ---------- Firebase SDK (v12) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, updateProfile, signOut,
      GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc,
      collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ---------- Config (your existing project) ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBWTOgHmlJmCtpb2LQ7g3wj_IMsTwyTNDE",
      authDomain: "quizzy-ea14d.firebaseapp.com",
      projectId: "quizzy-ea14d",
      storageBucket: "quizzy-ea14d.appspot.com",
      messagingSenderId: "452576898646",
      appId: "1:452576898646:web:9fa8dbc2e106bcce8615f7",
      measurementId: "G-VKNVF4YZCB"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    /* ---------- Helpers ---------- */
    const $ = (id) => document.getElementById(id);
    function show(id){
      // Ensure ONLY one section visible at a time (prevents side-by-side)
      document.querySelectorAll('section').forEach(s=>{
        s.classList.remove('active');
        s.style.display = 'none';
        s.style.opacity = '0';
      });
      const target = $(id);
      target.style.display = 'flex';
      requestAnimationFrame(()=>{ target.style.opacity = '1'; target.classList.add('active'); });

      if(id === "quiz" && auth.currentUser){
        fetchLastFive();
      }
    }
    function msg(text){ $("auth-msg").textContent = text || ""; }

    /* ---------------- Dynamic config ---------------- */
    // Data/ uses capital D; chapters are lowercase json files (chapter1.json, ...)
    const RAW_BASE = "https://raw.githubusercontent.com/singla1209/Quizzy/main/";
    const API_BASE = "https://api.github.com/repos/singla1209/Quizzy/contents/";

    // Subjects: Science & Math are dynamic (list chapters from GitHub), the rest remain static as before
    const SUBJECTS = [
      { key:"science", label:"Science",  dynamic:true,  path:"Data/science/" },
      { key:"math",    label:"Mathematics", dynamic:true, path:"Data/math/" },
      // The following three can point to your previous static JSONs (update if you move them)
      { key:"sst",     label:"Social Studies",   file:"questions_sst.json", host:"https://singla1209.github.io/Quiz_App/" },
      { key:"eng",     label:"English",          file:"questions_eng.json", host:"https://singla1209.github.io/Quiz_App/" },
      { key:"cs",      label:"Computer Science", file:"questions_cs.json",  host:"https://singla1209.github.io/Quiz_App/" }
    ];

    /* NCERT 2025–26 pretty names (fallback to filename if not listed) */
    const CHAPTER_TITLES = {
      science: {
        1: "Chemical Reactions and Equations",
        2: "Acids, Bases and Salts",
        3: "Metals and Non-metals",
        4: "Carbon and its Compounds",
        5: "Periodic Classification of Elements",
	6:  "Life Processes",
        7:  "Control and Coordination",
        8:  "How do Organisms Reproduce?",
        9:  "Heredity and Evolution",
        10: "Light – Reflection and Refraction",
        11: "The Human Eye and the Colourful World",
        12: "Electricity",
        13: "Magnetic Effects of Electric Current",
        14: "Sources of Energy",
        15: "Our Environment",
        16: "Management of Natural Resources"
      },
      math: {
        1: "Real Numbers",
        2: "Polynomials",
        3: "Pair of Linear Equations in Two Variables",
        4: "Quadratic Equations",
        5: "Arithmetic Progressions",
        6: "Triangles",
        7: "Coordinate Geometry",
        8: "Introduction to Trigonometry",
        9: "Applications of Trigonometry",
        10: "Circles",
        11: "Constructions",
        12: "Areas Related to Circles",
        13: "Surface Areas and Volumes",
        14: "Statistics",
        15: "Probability"
      }
    };

    /* ---------- Utility ---------- */
    function titleFromFilename(filename){
      // remove extension → split by non-alphanum → Title Case words
      const base = filename.replace(/\.json$/i,'').replace(/[_\-]+/g,' ').trim();
      return base.replace(/\s+/g,' ')
        .split(' ')
        .map(w=>w ? w[0].toUpperCase()+w.slice(1) : '')
        .join(' ');
    }

    function prettifyChapterName(filename, subjectKey){
      // capture chapter number if present
      const m = filename.match(/chapter\s*(\d+)/i);
      if(m){
        const n = parseInt(m[1],10);
        const map = CHAPTER_TITLES[subjectKey] || {};
        const pretty = map[n];
        if(pretty) return `Chapter ${n}: ${pretty}`;
        // fallback: use file words after number
        const rest = filename
          .replace(/\.json$/i,'')
          .replace(/chapter\s*\d+/i,'')
          .replace(/[_\-]+/g,' ')
          .trim();
        if(rest) return `Chapter ${n}: ${rest.replace(/\b\w/g,c=>c.toUpperCase())}`;
        return `Chapter ${n}`;
      }
      // no number found → filename-based
      return titleFromFilename(filename);
    }

    async function listChapters(path){
      const res = await fetch(API_BASE + path, { cache:"no-store" });
      if(!res.ok) throw new Error("GitHub API error");
      const items = await res.json();
      return items
        .filter(x => x.type === "file" && x.name.toLowerCase().endsWith(".json"))
        .sort((a,b)=>{
          const na = parseInt((a.name.match(/\d+/)||[9999])[0],10);
          const nb = parseInt((b.name.match(/\d+/)||[9999])[0],10);
          if(na !== nb) return na - nb;
          return a.name.localeCompare(b.name);
        });
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    /* ---------- State ---------- */
    let userName = "";
    let userId   = null;
    let subject  = null;
    let currentChapterTitle = "";
    let questions = [];
    let idx = 0, correct = 0, incorrect = 0, responses = [];
    let quizStartMs = null;

    /* Build subject buttons (keep layout) */
    const list = $("subject-list");
    SUBJECTS.forEach(s => {
      const btn = document.createElement("button");
      btn.className = "btn subject";
      btn.textContent = s.label;
      btn.onclick = () => startSubject(s);
      list.appendChild(btn);
    });

    /* ---------- Auth actions (unchanged flow) ---------- */
    $("login-btn").onclick = async () => {
      msg();
      let id = $("login-id").value.trim();
      const pass = $("login-pass").value;
      if(!id || !pass){ msg("Enter email/mobile and password."); return; }
      if(!id.includes("@")) id += "@mobile.com";
      try { await signInWithEmailAndPassword(auth, id, pass); }
      catch(e){ msg(humanAuthError(e)); }
    };

    $("google-btn").onclick = async () => {
      msg();
      try {
        const cred = await signInWithPopup(auth, googleProvider);
        await setDoc(doc(db, "users", cred.user.uid), {
          name: cred.user.displayName || "",
          emailOrMobile: cred.user.email || "",
          createdAt: serverTimestamp()
        }, { merge:true });
      } catch(e){ msg(humanAuthError(e)); }
    };

    $("signup-btn").onclick = async () => {
      msg();
      const name = $("signup-name").value.trim();
      let id = $("signup-id").value.trim();
      const pass = $("signup-pass").value;
      if(!name || !id || !pass){ msg("Fill all sign up fields."); return; }
      const rawId = id;
      if(!id.includes("@")) id += "@mobile.com";
      try {
        const cred = await createUserWithEmailAndPassword(auth, id, pass);
        await updateProfile(cred.user, { displayName: name });
        await setDoc(doc(db, "users", cred.user.uid), {
          name, emailOrMobile: rawId, createdAt: serverTimestamp()
        }, { merge:true });
      } catch(e){ msg(humanAuthError(e)); }
    };

    $("logout-1").onclick = () => signOut(auth);
    $("logout-2").onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if(user){
        userId = user.uid;
        userName = user.displayName || "";
        if(!userName){
          const snap = await getDoc(doc(db,"users",user.uid));
          userName = (snap.exists() && snap.data().name) ? snap.data().name : (user.email || "User");
        }
        $("hello").textContent = `Hi ${userName}!`;
        show("subjects");
        fetchLastFive();
      }else{
        userId = null;
        $("login-pass").value = "";
        $("signup-pass").value = "";
        show("auth");
      }
    });

    /* ---------- Quiz + Dynamic Chapters ---------- */
    async function startSubject(s){
      if(!auth.currentUser){ show("auth"); return; }
      subject = s;

      if(s.dynamic){
        // Step 1: list chapters
        $("chapters-title").textContent = `Choose a chapter – ${s.label}`;
        $("chapters-subtitle").textContent = `NCERT Class 10 • Session 2025–26`;
        const container = $("chapter-list");
        container.innerHTML = `<div class="muted" style="grid-column:1/-1">Loading chapters…</div>`;

        try{
          const items = await listChapters(s.path);
          if(!items.length){
            container.innerHTML = `<div class="muted" style="grid-column:1/-1">No chapter files found.</div>`;
          }else{
            container.innerHTML = "";
            items.forEach(file=>{
              const pretty = prettifyChapterName(file.name, s.key);
              const btn = document.createElement("button");
              btn.className = "btn chapter";
              btn.textContent = pretty;
              btn.onclick = () => startChapterQuiz(s, file.path, pretty);
              container.appendChild(btn);
            });
          }
        }catch(err){
          console.error(err);
          container.innerHTML = `<div class="muted" style="grid-column:1/-1">Couldn't load chapters.</div>`;
        }
        show("chapters");
        return;
      }

      // Non-dynamic subjects: keep previous static behavior
      currentChapterTitle = s.label;
      await beginQuizFromUrl((s.host || "") + s.file, s.label, currentChapterTitle);
    }

    $("back-to-subjects-2").onclick = () => show("subjects");

    async function startChapterQuiz(s, ghPath, prettyTitle){
      // ghPath like "Data/science/chapter1.json"
      const url = RAW_BASE + ghPath; // raw github
      currentChapterTitle = prettyTitle; // used in banner
      await beginQuizFromUrl(url, s.label, prettyTitle);
    }

    async function beginQuizFromUrl(url, subjectLabel, chapterTitle){
      idx = 0; correct = 0; incorrect = 0; responses = [];
      quizStartMs = null;
      $("stats").textContent = `✅ Correct: 0  |  ❌ Incorrect: 0`;
      $("qprogress").textContent = `Question 1/1`;
      $("bar-inner").style.width = "0%";
      $("end-screen").style.display = "none";

      // Banner format exactly as requested
      $("welcome-banner").innerHTML =
        `Welcome <span class="name">${userName}</span> in BrainQuest of <b>‘${subjectLabel}’ : ${chapterTitle.replace(/^Chapter\s*\d+\s*:\s*/i,'')}</b>`;

      show("quiz");

      try{
        const res = await fetch(url, {cache:"no-store"});
        const raw = await res.json();
        // Defensive: ensure array
        questions = Array.isArray(raw) ? raw.slice() : [];
      }catch(e){ questions = []; }

      if(!questions.length){
        $("question").textContent = "Could not load questions.";
        $("options").innerHTML = "";
        fetchLastFive();
        return;
      }

      // Shuffle questions
      shuffle(questions);

      // Prepare each question with shuffled options array and preserved correct key
      questions = questions.map(q => {
        const entries = Object.entries(q.options || {}).map(([key,text]) => ({key, text}));
        shuffle(entries);
        return { ...q, _optionsArr: entries, _correctKey: q.correct };
      });

      renderQuestion();
      fetchLastFive();
    }

    function renderQuestion(){
      const q = questions[idx];
      $("question").textContent = `Q${idx+1}. ${q.question}`;
      const optionsDiv = $("options");
      optionsDiv.innerHTML = "";

      q._optionsArr.forEach(opt=>{
        const div = document.createElement("div");
        div.className = "option";
        div.textContent = opt.text;   // no A/B/C labels, only text
        div.onclick = () => choose(opt.key, div); // compare by original key
        optionsDiv.appendChild(div);
      });

      $("qprogress").textContent = `Question ${idx+1}/${questions.length}`;
      $("bar-inner").style.width = `${((idx)/questions.length)*100}%`;
      if(quizStartMs === null) quizStartMs = Date.now();
    }

    function choose(selectedKey, el){
      // lock
      document.querySelectorAll(".option").forEach(o => o.style.pointerEvents = "none");
      const q = questions[idx];
      const correctKey = q._correctKey;

      // mark styles by comparing keys
      document.querySelectorAll(".option").forEach(o=>{
        const isCorrect = q._optionsArr.find(x => x.text === o.textContent)?.key === correctKey;
        if(isCorrect) o.classList.add("correct");
      });
      if(selectedKey !== correctKey) el.classList.add("wrong");

      const selectedObj = q._optionsArr.find(x=>x.key===selectedKey);
      const correctObj  = q._optionsArr.find(x=>x.key===correctKey);
      const selectedAnswer = selectedObj ? selectedObj.text : "No answer";
      const correctAnswer  = correctObj  ? correctObj.text  : "";

      responses.push({ question: q.question, selected: selectedAnswer, correct: correctAnswer });

      if(selectedKey === correctKey){ correct++; $("correct-sound").play(); }
      else { incorrect++; $("wrong-sound").play(); }

      $("stats").textContent = `✅ Correct: ${correct}  |  ❌ Incorrect: ${incorrect}`;
      $("bar-inner").style.width = `${((idx+1)/questions.length)*100}%`;

      setTimeout(()=>{
        if(idx < questions.length-1){ idx++; renderQuestion(); }
        else { finishQuiz(); }
      }, 900);
    }

    function secsToText(s){
      s = Math.max(0, Math.round(s));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}m ${r}s`;
    }
    function toMillis(df){
      if(!df) return 0;
      if(typeof df.toDate === "function") return df.toDate().getTime();
      return new Date(df).getTime() || 0;
    }

    async function finishQuiz(){
      $("question").textContent = "All done!";
      $("options").innerHTML = "";
      $("end-screen").style.display = "block";
      $("end-screen").innerHTML = `
        <h3>Score: ${correct} / ${questions.length}</h3>
      `;

      const timeTakenSec = quizStartMs ? (Date.now() - quizStartMs)/1000 : 0;

      try{
        const current = auth.currentUser;
        await addDoc(collection(db, "quiz_results"), {
          name: (userName || current?.displayName || ""),
          score: correct,
          totalQuestions: questions.length,
          correctAnswers: correct,
          incorrectAnswers: questions.length - correct,
          responses: responses,
          date: serverTimestamp(),
          subject: subject ? `${subject.label} : ${currentChapterTitle}` : null,
          userId: current ? current.uid : null,
          userEmail: current ? current.email : null,
          timeTakenSec: Math.round(timeTakenSec)
        });
        fetchLastFive();
      }catch(e){
        console.error("Save failed:", e);
      }

      const pct = questions.length ? (correct / questions.length) * 100 : 0;
      launchCelebration(Math.round(pct));
    }

    /* ---------- Last 5 results ---------- */
    async function fetchLastFive(){
      const body = $("last5-body");
      if(!auth.currentUser){ body.innerHTML = `<tr><td class="muted" colspan="6">Please log in to see results.</td></tr>`; return; }
      body.innerHTML = `<tr><td class="muted" colspan="6">Loading…</td></tr>`;
      try{
        const snap = await getDocs(query(
          collection(db, "quiz_results"),
          orderBy("date","desc"),
          limit(50)
        ));

        const current = auth.currentUser;
        const email = current?.email || null;
        const list = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const match =
            (d.userId && userId && d.userId === userId) ||
            (d.userEmail && email && d.userEmail === email) ||
            (d.name && userName && String(d.name).trim().toLowerCase() === String(userName).trim().toLowerCase());
          if(match) list.push(d);
        });

        if(!list.length){
          body.innerHTML = `<tr><td class="muted" colspan="6">No results yet. Finish a quiz to see it here.</td></tr>`;
          return;
        }

        list.sort((a,b)=> toMillis(b.date) - toMillis(a.date));
        const top5 = list.slice(0,5);

        body.innerHTML = "";
        top5.forEach(d=>{
          const dt = d.date?.toDate ? d.date.toDate() : (d.date ? new Date(d.date) : null);
          const dtTxt = dt ? dt.toLocaleString() : "";
          const total = Number(d.totalQuestions)||0;
          const corr  = Number(d.correctAnswers)||0;
          const inc   = Number(d.incorrectAnswers) || Math.max(0,total-corr);
          const secs  = Number(d.timeTakenSec)||0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${dtTxt}</td>
            <td>${d.subject||"N/A"}</td>
            <td>${d.name||""}</td>
            <td>${corr}</td>
            <td>${inc}</td>
            <td>${secsToText(secs)}</td>
          `;
          tr.onclick = ()=> openModalForResult(d);
          body.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        body.innerHTML = `<tr><td class="muted" colspan="6">Couldn't load results.</td></tr>`;
      }
    }

    /* ---------- Modal helpers ---------- */
    function openModalForResult(data){
      const content = $("modal-content");
      const dt = data.date?.toDate ? data.date.toDate().toLocaleString() :
                 (data.date ? new Date(data.date).toLocaleString() : "");
      const total = Number(data.totalQuestions)||0;
      const corr  = Number(data.correctAnswers)||0;
      const secs  = Number(data.timeTakenSec)||0;

      let html = `
        <h3 style="margin:0 24px 6px 6px;text-align:left">
          ${data.subject || "Result"} 
          <span class="tag">${dt}</span>
        </h3>
        <p class="muted" style="text-align:left;margin:0 0 10px 6px">
          Name: <b>${data.name||""}</b> &nbsp; • &nbsp; Score: <b>${corr}/${total}</b> &nbsp; • &nbsp; Time: <b>${secsToText(secs)}</b>
        </p>
      `;

      if(Array.isArray(data.responses) && data.responses.length){
        data.responses.forEach((r,i)=>{
          html += `
            <div class="qrow">
              <div class="q">Q${i+1}. ${r.question || ""}</div>
              <div>Attempted: <b>${r.selected || ""}</b></div>
              <div>Correct: <b>${r.correct || ""}</b></div>
            </div>
          `;
        });
      }else{
        html += `<div class="qrow">No response details saved.</div>`;
      }

      content.innerHTML = html;
      $("modal-overlay").style.display = "flex";
    }
    $("modal-close").onclick = ()=> $("modal-overlay").style.display = "none";
    $("modal-overlay").addEventListener("click", (e)=>{
      if(e.target.id === "modal-overlay") $("modal-overlay").style.display = "none";
    });

    /* ---------- Errors ---------- */
    function humanAuthError(e){
      const code = (e && e.code) ? e.code : "";
      switch(code){
        case "auth/invalid-email": return "Please enter a valid email.";
        case "auth/missing-password": return "Please enter your password.";
        case "auth/invalid-credential":
        case "auth/wrong-password":
        case "auth/user-not-found": return "Invalid email/mobile or password.";
        case "auth/cancelled-popup-request":
        case "auth/popup-closed-by-user": return "Google sign-in was closed. Try again.";
        case "auth/email-already-in-use": return "This email/mobile is already registered. Try logging in.";
        case "auth/weak-password": return "Password should be at least 6 characters.";
        default: return e.message || "Authentication error.";
      }
    }

    /* ---------- Nav ---------- */
    $("back-to-subjects").onclick = () => show("subjects");

    /* =======================================================
       Celebration: confetti (canvas), donut, random messages
       ======================================================= */
    const confettiCanvas = $("confetti");
    const ctxC = confettiCanvas.getContext("2d");
    let confettiParticles = [];
    let ribbons = [];
    let confettiAnimating = false;

    const messagesLow = [
      "Every step counts — keep going!",
      "Good try! Let’s push a little more next time.",
      "You’re learning fast — don’t stop!",
      "Progress over perfection!",
      "Nice effort — keep at it!"
    ];
    const messagesMid = [
      "Nice work — you’re getting there!",
      "Solid score! Keep the momentum.",
      "You’re on the right track!",
      "Nice rhythm — consistency wins.",
      "Great effort — aim higher next time!"
    ];
    const messagesHigh = [
      "Outstanding! You’re a star!",
      "Brilliant performance — keep shining!",
      "Fantastic! You nailed it!",
      "Superb — excellence achieved!",
      "Incredible work — way to go!"
    ];

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function sizeCanvas(){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    sizeCanvas();
    window.addEventListener("resize", sizeCanvas);

    function spawnConfetti(count, speedMin, speedMax){
      for(let i=0;i<count;i++){
        confettiParticles.push({
          x: Math.random()*confettiCanvas.width,
          y: -20 - Math.random()*confettiCanvas.height*0.5,
          w: 6 + Math.random()*6,
          h: 10 + Math.random()*10,
          tilt: Math.random()*2*Math.PI,
          tiltSpeed: 0.02 + Math.random()*0.08,
          vy: speedMin + Math.random()*(speedMax-speedMin),
          vx: (Math.random()-0.5)*2,
          color: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
        });
      }
    }
    function spawnRibbons(count){
      for(let i=0;i<count;i++){
        ribbons.push({
          x: Math.random()*confettiCanvas.width,
          y: -50 - Math.random()*200,
          len: 80 + Math.random()*100,
          amp: 10 + Math.random()*20,
          phase: Math.random()*Math.PI*2,
          vy: 1.2 + Math.random()*2,
          color: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
        });
      }
    }

    function drawConfetti(){
      ctxC.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

      // rectangles
      confettiParticles.forEach(p=>{
        p.tilt += p.tiltSpeed;
        p.y += p.vy;
        p.x += p.vx + Math.sin(p.tilt)*0.3;
        ctxC.fillStyle = p.color;
        ctxC.save();
        ctxC.translate(p.x, p.y);
        ctxC.rotate(p.tilt);
        ctxC.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctxC.restore();
      });
      confettiParticles = confettiParticles.filter(p => p.y < confettiCanvas.height + 40);

      // ribbons
      ribbons.forEach(r=>{
        r.y += r.vy;
        r.phase += 0.08;
        ctxC.strokeStyle = r.color;
        ctxC.lineWidth = 6;
        ctxC.beginPath();
        for(let t=0;t<r.len;t+=6){
          const xx = r.x + Math.sin(r.phase + t*0.08)*r.amp;
          const yy = r.y + t;
          if(t===0) ctxC.moveTo(xx,yy); else ctxC.lineTo(xx,yy);
        }
        ctxC.stroke();
      });
      ribbons = ribbons.filter(r => r.y < confettiCanvas.height + r.len);

      if(confettiParticles.length || ribbons.length){
        requestAnimationFrame(drawConfetti);
      }else{
        confettiAnimating = false;
      }
    }

    function startConfetti(level){
      sizeCanvas();
      if(level === "low"){
        spawnConfetti(120, 2, 3.5);
        spawnRibbons(6);
      }else if(level === "mid"){
        spawnConfetti(280, 2.5, 4.2);
        spawnRibbons(10);
      }else{
        spawnConfetti(480, 3, 5);
        spawnRibbons(16);
        for(let i=0;i<4;i++){
          setTimeout(()=>spawnConfetti(120, 3, 5), i*220);
        }
      }
      if(!confettiAnimating){
        confettiAnimating = true;
        drawConfetti();
      }
    }

    function renderDonut(score, total){
      const c = $("donut");
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);

      const pct = total ? score/total : 0;
      const cx = c.width/2, cy = c.height/2, r = 70, thickness = 22;

      // track
      ctx.lineWidth = thickness;
      ctx.strokeStyle = "rgba(255,255,255,.2)";
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();

      // value arc
      let color = "#ffb703";
      if(pct >= 0.8) color = "#00e6b0";
      else if(pct >= 0.5) color = "#5ab0ff";

      ctx.strokeStyle = color;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.arc(cx, cy, r, -Math.PI/2, -Math.PI/2 + pct*2*Math.PI, false);
      ctx.stroke();

      // text
      ctx.fillStyle = "#fff";
      ctx.font = "bold 24px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`${Math.round(pct*100)}%`, cx, cy-6);

      ctx.font = "12px Arial";
      ctx.fillStyle = "rgba(255,255,255,.8)";
      ctx.fillText(`${score}/${total}`, cx, cy+14);
    }

    function launchCelebration(pct){
      let level = "low";
      let m = pickRandom(messagesLow);
      if(pct >= 80){ level = "high"; m = pickRandom(messagesHigh); }
      else if(pct >= 50){ level = "mid"; m = pickRandom(messagesMid); }

      $("celebrate-overlay").style.display = "flex";
      $("big-name").textContent = `${userName || "Great Job!"}`;
      $("motivation").textContent = m;

      renderDonut(correct, questions.length);
      startConfetti(level);
    }

    $("celebrate-close").onclick = () => {
      $("celebrate-overlay").style.display = "none";
    };
    $("play-again-btn").onclick = () => {
      $("celebrate-overlay").style.display = "none";
      show("subjects");
    };
  </script>
</body>
</html>
