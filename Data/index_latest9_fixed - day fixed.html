<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Timetable Generator (No Clashes, No Empty Classes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--pri:#0d6efd;--bg:#f7f8fb;--card:#fff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .container{max-width:1100px;margin:auto;padding:18px}
    h1{margin:0 0 14px}
    h2{margin:16px 0 8px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 200px}
    input,select,button{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    button{cursor:pointer;background:var(--pri);color:#fff;border:none}
    button.ghost{background:#fff;color:#111;border:1px solid #e5e7eb}
    button.danger{background:#ef4444}
    .list-box{background:#fafafa;border:1px dashed #e5e7eb;border-radius:10px;padding:8px;min-height:44px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;vertical-align:top}
    th{background:#f3f4f6}
    .scroll{overflow:auto}
    .muted{color:var(--muted);font-size:12px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:10px;margin-top:8px}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px;margin-top:8px}
    .pill{display:inline-block;background:#f1f5f9;border:1px solid #e2e8f0;padding:2px 8px;border-radius:999px;font-size:12px;margin:2px 4px 0 0}
    .small{font-size:12px}
    .tbl-wrap{max-height:420px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Teacher Timetable Generator</h1>

    <!-- Settings -->
    <div class="card">
      <h2>Settings</h2>
</br>
<label class="grow">Upload Raw JSON
  <input type="file" id="jsonUpload" accept=".json" />
</label>
</br></br>
      <div class="row">
        <label class="grow">Periods per Day
          <input id="periodsPerDay" type="number" min="1" value="8" />
        </label>
        <label class="grow">Working Days per Week
          <input id="workingDays" type="number" min="1" max="6" value="6" />
        </label>
      </div>
      <div class="muted">Available slots per class per week: <span id="slotsPill" class="pill">—</span></div>
    </div>

    <!-- Teachers -->
    <div class="card">
      <h2>Teachers</h2>
      <div class="row">
        <input id="tName" class="grow" placeholder="Teacher name (e.g., Mohan)" />
        <button onclick="addTeacher()">Add Teacher</button>
      </div>
      <div class="muted small">Teacher Availability (Mon–Sat)</div>
      <div id="dayCheckboxes" class="row" style="flex-wrap:wrap; gap:8px; margin-top:6px">
        <label><input type="checkbox" id="dayAll" onchange="toggleAllDays(this)"> Select All</label>
        <label><input type="checkbox" class="dayChk" value="0"> Mon</label>
        <label><input type="checkbox" class="dayChk" value="1"> Tue</label>
        <label><input type="checkbox" class="dayChk" value="2"> Wed</label>
        <label><input type="checkbox" class="dayChk" value="3"> Thu</label>
        <label><input type="checkbox" class="dayChk" value="4"> Fri</label>
        <label><input type="checkbox" class="dayChk" value="5"> Sat</label>
      </div>
      <div id="teacherList" class="list-box"></div>
    </div>

    <!-- Classes -->
    <div class="card">
      <h2>Classes</h2>
      <div class="row">
        <input id="cClass" class="grow" placeholder="Class (e.g., 6)" />
        <input id="cSection" class="grow" placeholder="Section (e.g., A)" />
        <button onclick="addClass()">Add Class</button>
      </div>
      <div id="classList" class="list-box"></div>
    </div>

    <!-- Subjects -->
    <div class="card">
      <h2>Subjects</h2>
      <div class="row">
        <input id="sName" class="grow" placeholder="Subject (e.g., English, Math)" />
        <button onclick="addSubject()">Add Subject</button>
      </div>
      <div id="subjectList" class="list-box"></div>
    </div>

    <!-- Assignments -->
    <div class="card">
      <h2>Assign Teacher → Subject → Class</h2>
      <div class="row">
        <select id="asTeacher" class="grow"></select>
        <select id="asSubject" class="grow"></select>
        <select id="asClass" class="grow"></select>
        <button onclick="addAssignment()">Add Assignment</button>
      </div>
      <div class="tbl-wrap scroll" id="assignTable"></div>
      <div class="muted">Each class–subject that has weekly periods must have exactly one teacher here.</div>
    </div>

    <!-- Class Incharge -->
    <div class="card">
      <h2>Class Incharge</h2>
      <div class="row">
        <select id="icTeacher" class="grow"></select>
        <select id="icClass" class="grow"></select>
        <button onclick="addIncharge()">Set Incharge</button>
      </div>
      <div id="inchargeList" class="list-box"></div>
      <div class="muted small">
        The incharge teacher will be placed in <b>Period 1</b> each day for that class (when possible).
      </div>
    </div>

    <!-- Weekly Periods Matrix -->
    <div class="card">
      <h2>Weekly Periods (fill once for all class–subject)</h2>
      <div class="muted">Rows = Classes; Columns = Subjects. Enter required periods/week for each class–subject, then Save.</div>
      <div id="matrixWrap" class="scroll" style="max-height:380px"></div>
      <div class="row">
        <button class="ghost" onclick="fillHeuristics()">Auto-fill suggestion</button>
        <button onclick="saveWeeklyPeriods()">Save Weekly Periods</button>
      </div>
      <div id="matrixInfo" class="muted"></div>
    </div>

    <!-- Teacher Load -->
    <div class="card">
      <h2>Teacher Load</h2>
      <div id="teacherLoad"></div>
      <div class="muted small">Shown as <b>assigned / total</b> where total = periods/day × working days.</div>
    </div>

    <!-- Generate -->
    <div class="card">
      <h2>Generate Timetable</h2>
      <div class="row">
        <button onclick="generateTimetable()">Generate</button>
        <button class="ghost" onclick="downloadClasswiseExcel()">Download Class-wise Excel</button>
        <button class="ghost" onclick="downloadTeacherwiseExcel()">Download Teacher-wise Excel</button>
        <button class="ghost" onclick="downloadJson()">Download Latest JSON</button>
      </div>
      <div id="warnBox" class="warn" style="display:none"></div>
      <div id="okBox" class="ok" style="display:none"></div>
      <h3>Class-wise</h3>
      <div id="classTT" class="scroll"></div>
      <h3>Teacher-wise</h3>
      <div id="teacherTT" class="scroll"></div>
    </div>
  </div>

<script>
/* ---------- STATE ---------- */
let TEACHERS = [];       // ["Mohan", "Sohan", ...]
let CLASSES = [];        // ["6A", "7B", ...]
let SUBJECTS = [];       // ["English", ...]
let ASSIGN = [];         // [{teacher, subject, cls}]
let WEEKLY = {};         // { cls: { subject: count } }
let INCHARGE = {};       // { cls: teacher }
let AVAIL = {};         // { teacher: [dayIndex] }

let classSchedule = {};   // { cls: [ [cells] per day ] }
let teacherSchedule = {}; // { teacher: [ [cells] per day ] }

/* ---------- HELPERS ---------- */
const $ = (id) => document.getElementById(id);
const range = (n) => Array.from({length:n}, (_,i)=>i);
const shuffle = (arr) => arr.sort(()=>Math.random()-0.5);

/* ---------- DAY CHECKBOX HELPERS ---------- */
function toggleAllDays(cb){
  document.querySelectorAll('.dayChk').forEach(c => c.checked = cb.checked);
}
function getSelectedDayIdx(){
  const days = [];
  document.querySelectorAll('.dayChk:checked').forEach(c=> days.push(+c.value));
  return days;
}

/* Teacher availability check (default: all days if not specified) */
function teacherAvailable(t, d){
  const arr = AVAIL && AVAIL[t];
  if(!arr || !arr.length) return true;
  return arr.includes(d);
}


function updateSelectors(){
  const tOpts = TEACHERS.map(t=>`<option>${t}</option>`).join("");
  const sOpts = SUBJECTS.map(s=>`<option>${s}</option>`).join("");
  const cOpts = CLASSES.map(c=>`<option>${c}</option>`).join("");
  $("asTeacher").innerHTML = tOpts; $("icTeacher").innerHTML = tOpts;
  $("asSubject").innerHTML = sOpts;
  $("asClass").innerHTML = cOpts; $("icClass").innerHTML = cOpts;
}
function calcSlotsPill(){
  const P = +$("periodsPerDay").value || 0;
  const D = +$("workingDays").value || 0;
  $("slotsPill").textContent = `${D} × ${P} = ${D*P} slots/week`;
}

/* ---------- RENDER LISTS ---------- */
function renderTeachers(){
  const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat"];
  $("teacherList").innerHTML =
    TEACHERS.map((t,i)=>{
      // Use saved availability if present; otherwise assume all working days
      const wd = +($("workingDays")?.value || 6);
      const idxs = (typeof AVAIL !== "undefined" && AVAIL && AVAIL[t] && AVAIL[t].length)
        ? AVAIL[t]
        : Array.from({length: wd}, (_,k)=>k);

      const days = idxs.map(d => dayNames[d]).join(", ");
      return `<div class="row">
                <div class="grow">${t}${days ? " – Days: " + days : ""}</div>
                <button class="danger" onclick="delTeacher(${i})">Delete</button>
              </div>`;
    }).join("") || '<div class="muted">No teachers yet.</div>';
}
function renderClasses(){
  $("classList").innerHTML =
    CLASSES.map((c,i)=>`<div class="row"><div class="grow">${c}</div><button class="danger" onclick="delClass(${i})">Delete</button></div>`).join("") 
    || '<div class="muted">No classes yet.</div>';
}
function renderSubjects(){
  $("subjectList").innerHTML =
    SUBJECTS.map((s,i)=>`<div class="row"><div class="grow">${s}</div><button class="danger" onclick="delSubject(${i})">Delete</button></div>`).join("") 
    || '<div class="muted">No subjects yet.</div>';
}
function renderAssign(){
  if(!ASSIGN.length){ $("assignTable").innerHTML = '<div class="muted">No assignments yet.</div>'; return; }
  let html = '<table><thead><tr><th>Teacher</th><th>Subject</th><th>Class</th><th>Action</th></tr></thead><tbody>';
  ASSIGN.forEach((a,i)=>{
    html += `<tr><td>${a.teacher}</td><td>${a.subject}</td><td>${a.cls}</td>
             <td><button class="danger" onclick="delAssign(${i})">Delete</button></td></tr>`;
  });
  html += '</tbody></table>';
  $("assignTable").innerHTML = html;
}
function renderIncharge(){
  $("inchargeList").innerHTML =
    Object.keys(INCHARGE).length
      ? Object.entries(INCHARGE).map(([c,t])=>`<div class="row"><div class="grow"><b>${c}</b> → ${t}</div><button class="danger" onclick="delIncharge('${c}')">Remove</button></div>`).join("")
      : '<div class="muted">No class incharge set.</div>';
}

/* ---------- ADD/DEL ---------- */
function addTeacher(){
  const v = $("tName").value.trim();
  if(!v) return;
  if(TEACHERS.includes(v)) return alert("Teacher already exists.");
  TEACHERS.push(v);
  // Save availability for this teacher (if none selected => treat as all days)
  AVAIL[v] = getSelectedDayIdx();
  $("tName").value="";
  // reset day checkboxes
  document.querySelectorAll('.dayChk').forEach(c=> c.checked=false);
  const all = document.getElementById('dayAll'); if(all) all.checked=false;
  renderTeachers(); updateSelectors(); updateTeacherLoad(); renderIncharge();
}
function delTeacher(i){
  const name = TEACHERS[i];
  TEACHERS.splice(i,1);
  delete AVAIL[name];
  for(const c of Object.keys(INCHARGE)) if(INCHARGE[c]===name) delete INCHARGE[c];
  ASSIGN = ASSIGN.filter(a=>a.teacher!==name);
  renderTeachers(); renderAssign(); updateSelectors(); updateTeacherLoad(); renderIncharge();
}
function addClass(){
  const c = $("cClass").value.trim();
  const s = $("cSection").value.trim().toUpperCase();
  if(!c || !s) return;
  const id = `${c}${s}`;
  if(CLASSES.includes(id)) return alert("Class already exists.");
  CLASSES.push(id);
  $("cClass").value=""; $("cSection").value="";
  renderClasses(); updateSelectors(); renderMatrix(); updateTeacherLoad(); renderIncharge();
}
function delClass(i){
  const id = CLASSES[i];
  CLASSES.splice(i,1);
  ASSIGN = ASSIGN.filter(a=>a.cls!==id);
  delete WEEKLY[id];
  delete INCHARGE[id];
  renderClasses(); renderAssign(); updateSelectors(); renderMatrix(); updateTeacherLoad(); renderIncharge();
}
function addSubject(){
  const s = $("sName").value.trim();
  if(!s) return;
  if(SUBJECTS.includes(s)) return alert("Subject already exists.");
  SUBJECTS.push(s);
  $("sName").value="";
  renderSubjects(); updateSelectors(); renderMatrix(); updateTeacherLoad();
}
function delSubject(i){
  const s = SUBJECTS[i];
  SUBJECTS.splice(i,1);
  ASSIGN = ASSIGN.filter(a=>a.subject!==s);
  for(const c of Object.keys(WEEKLY)) if(WEEKLY[c]) delete WEEKLY[c][s];
  renderSubjects(); renderAssign(); updateSelectors(); renderMatrix(); updateTeacherLoad();
}

function addAssignment(){
  const teacher=$("asTeacher").value, subject=$("asSubject").value, cls=$("asClass").value;
  if(!teacher || !subject || !cls) return;
  const idx = ASSIGN.findIndex(a=>a.cls===cls && a.subject===subject);
  if(idx>=0){
    if(!confirm(`Replace existing teacher for ${cls} – ${subject}?`)) return;
    ASSIGN.splice(idx,1);
  }
  ASSIGN.push({teacher, subject, cls});
  renderAssign(); updateTeacherLoad();
}
function delAssign(i){
  ASSIGN.splice(i,1);
  renderAssign(); updateTeacherLoad();
}

/* Incharge */
function addIncharge(){
  const t=$("icTeacher").value, c=$("icClass").value;
  if(!t || !c) return;
  INCHARGE[c] = t;
  renderIncharge();
}
function delIncharge(cls){
  delete INCHARGE[cls];
  renderIncharge();
}

/* ---------- WEEKLY MATRIX ---------- */
function ensureWEEKLY(){
  CLASSES.forEach(c=>{
    WEEKLY[c] = WEEKLY[c] || {};
    SUBJECTS.forEach(s=>{
      if(typeof WEEKLY[c][s] !== 'number') WEEKLY[c][s] = 0;
    });
  });
}
function renderMatrix(){
  ensureWEEKLY();
  if(!CLASSES.length || !SUBJECTS.length){
    $("matrixWrap").innerHTML = '<div class="muted">Add classes and subjects to see the matrix.</div>';
    $("matrixInfo").innerHTML = "";
    return;
  }
  let html = '<table><thead><tr><th>Class \\ Subject</th>';
  SUBJECTS.forEach(s=> html += `<th>${s}</th>`); 
  html += '</tr></thead><tbody>';
  [...CLASSES].sort().forEach(c=>{
    html += `<tr><th>${c}</th>`;
    SUBJECTS.forEach(s=>{
      const val = WEEKLY[c]?.[s] ?? 0;
      html += `<td><input type="number" min="0" value="${val}" style="width:80px" data-c="${c}" data-s="${s}" /></td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  $("matrixWrap").innerHTML = html;
  showMatrixInfo();
}
function saveWeeklyPeriods(){
  ensureWEEKLY();
  const inputs = $("matrixWrap").querySelectorAll('input[type="number"]');
  inputs.forEach(inp=>{
    const c = inp.getAttribute('data-c');
    const s = inp.getAttribute('data-s');
    const v = parseInt(inp.value||'0',10);
    WEEKLY[c][s] = isNaN(v) ? 0 : v;
  });
  showMatrixInfo(); updateTeacherLoad();
  alert('Weekly periods saved.');
}
function totalForClass(c){ return Object.values(WEEKLY[c]||{}).reduce((a,b)=>a+(+b||0),0); }
function showMatrixInfo(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0, slots=P*D;
  let t=''; CLASSES.forEach(c=> t += `<span class="pill">${c}: ${totalForClass(c)} / ${slots}</span>`);
  $("matrixInfo").innerHTML=t;
}
function fillHeuristics(){
  CLASSES.forEach(c=>{
    SUBJECTS.forEach(s=>{
      let v = 2;
      if(/english/i.test(s)) v=9;
      if(/math/i.test(s)) v=9;
      if(/science/i.test(s)) v=5;
      if(/punjabi/i.test(s)) v=12;
      if(/s\.?st/i.test(s)) v=5;
      if(/phy/i.test(s)) v=3;
      WEEKLY[c][s] = v;
    });
  });
  renderMatrix(); showMatrixInfo(); updateTeacherLoad();
}

/* ---------- TEACHER LOAD ---------- */
function updateTeacherLoad(){
  const max = (+$("periodsPerDay").value||0) * (+$("workingDays").value||0);
  const load = {}; TEACHERS.forEach(t=>load[t]=0);
  ASSIGN.forEach(a=>{
    const cnt = WEEKLY[a.cls]?.[a.subject] || 0;
    load[a.teacher] += cnt;
  });
  $("teacherLoad").innerHTML = TEACHERS.length
    ? TEACHERS.map(t=>`<div>${t}: ${load[t]} / ${max}</div>`).join("")
    : '<div class="muted">No teachers yet.</div>';
}

/* ---------- VALIDATION ---------- */
function validateAll(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0, slots=P*D;
  const missing = [];

  for(const c of CLASSES){
    for(const s of SUBJECTS){
      const need = WEEKLY[c]?.[s] || 0;
      if(need>0){
        const ok = ASSIGN.some(a=>a.cls===c && a.subject===s);
        if(!ok) missing.push(`${c} – ${s}`);
      }
    }
    if(totalForClass(c) > slots){
      return {ok:false, msg:`${c}: required periods (${totalForClass(c)}) exceed available slots (${slots}). Reduce counts or increase periods/day.`};
    }
  }
  if(missing.length){
    return {ok:false, msg:`The following class–subject need a teacher assignment:\n• ${missing.join('\n• ')}`};
  }
  return {ok:true};
}

/* ---------- SCHEDULER UTILITIES ---------- */
function teacherOf(cls, subject){
  const a = ASSIGN.find(x=>x.cls===cls && x.subject===subject);
  return a ? a.teacher : null;
}
function initGrids(D,P){
  classSchedule = {}; CLASSES.forEach(c=> classSchedule[c] = range(D).map(()=>range(P).map(()=>null)));
  teacherSchedule = {}; TEACHERS.forEach(t=> teacherSchedule[t] = range(D).map(()=>range(P).map(()=>null)));
}
function countPlacedForClassSubject(cls, subject){
  return classSchedule[cls]?.flat().filter(x=>x && x.subject===subject).length || 0;
}
function violatesRun(c,d,p,subj){
  const row = classSchedule[c][d];
  const x1 = row[p-1]?.subject, x2=row[p-2]?.subject;
  return (x1===subj && x2===subj);
}
function place(cls, subject, d, p){
  const t = teacherOf(cls, subject);
  classSchedule[cls][d][p] = {subject, teacher:t};
  teacherSchedule[t][d][p] = {subject, cls};
}

/* Distribute weekly counts of subjects across days fairly (soft rule “subject each day if possible”). */
function splitAcrossDays(count, D){
  const arr = Array(D).fill(0);
  for(let i=0;i<count;i++) arr[i%D]++;
  return arr; // entries differ by at most 1
}

/* Build a day plan for a class (subject-only), honoring:
   - incharge at P1 when possible
   - fair spread across days
   - max 2 consecutive per day (soft later) */
function buildClassPlan(cls, D, P){
  const counts = Object.assign({}, WEEKLY[cls]||{});
  for(const s of Object.keys(counts)) if(!counts[s]) delete counts[s];

  const dayBuckets = Array.from({length:D}, ()=>({}));
  let offset = Math.floor(Math.random()*D) || 0;

  Object.entries(counts).forEach(([s,cnt])=>{
    const base = splitAcrossDays(cnt, D);
    const rot = base.map((v,i)=>base[(i+offset)%D]);
    for(let d=0; d<D; d++){
      if(rot[d]>0) dayBuckets[d][s] = (dayBuckets[d][s]||0) + rot[d];
    }
    offset = (offset+1)%D;
  });

  // Ensure P1 preference for incharge
  const inc = INCHARGE[cls];
  if(inc){
    const incSubjects = ASSIGN.filter(a=>a.cls===cls && a.teacher===inc).map(a=>a.subject);
    for(let d=0; d<D; d++){
      const day = dayBuckets[d];
      const candidate = incSubjects.find(s=> (day[s]||0)>0 );
      if(candidate) continue;
      // borrow one from another day that has >1
      let borrowed = false;
      for(const s of incSubjects){
        for(let d2=0; d2<D; d2++){
          if(d2!==d && (dayBuckets[d2][s]||0)>1){
            dayBuckets[d2][s]--; dayBuckets[d][s]=(dayBuckets[d][s]||0)+1; borrowed=true; break;
          }
        }
        if(borrowed) break;
      }
    }
  }

  // Fill periods per day with greedy, limiting runs to 2
  const plan = range(D).map(()=>Array(P).fill(null));
  for(let d=0; d<D; d++){
    const need = Object.assign({}, dayBuckets[d]);
    const incT = INCHARGE[cls];
    if(incT){
      const incSubjects = ASSIGN.filter(a=>a.cls===cls && a.teacher===incT).map(a=>a.subject);
      const sInc = incSubjects.find(s=> (need[s]||0)>0 );
      if(sInc) { plan[d][0]=sInc; need[sInc]--; }
    }
    for(let p=0; p<P; p++){
      if(plan[d][p]) continue;
      const options = Object.entries(need).filter(([s,v])=>v>0).sort((a,b)=>b[1]-a[1]).map(([s])=>s);
      let placed=false;
      for(const s of options){
        const s1 = plan[d][p-1], s2 = plan[d][p-2];
        if(s1===s && s2===s) continue;
        plan[d][p]=s; need[s]--; placed=true; break;
      }
      // leave null if nothing fits here; will be handled later
    }
  }
  return plan; // D x P (subjects or null)
}

/* ---------- NEW: repair to enforce "no empty" and exact counts ---------- */
function repairToNoEmpty(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;

  // 1) compute remaining needs per class-subject
  const needMap = {};
  for(const c of CLASSES){
    needMap[c] = {};
    for(const s of SUBJECTS){
      const target = WEEKLY[c]?.[s]||0;
      const have = countPlacedForClassSubject(c,s);
      const remain = Math.max(0, target - have);
      if(remain>0) needMap[c][s]=remain;
    }
  }

  // 2) simple fill: use empty cells where teacher is free (ignore run limit here)
  function teacherFreeAt(t,d,p){ return teacherAvailable(t,d) && !teacherSchedule[t][d][p]; }
  function classCellEmpty(c,d,p){ return !classSchedule[c][d][p]; }

  for(const c of CLASSES){
    for(const [s,rem] of Object.entries(needMap[c]||{})){
      let left = rem;
      const t = teacherOf(c,s);
      while(left>0){
        let placed=false;
        for(let d=0; d<D && !placed; d++){
          for(let p=0; p<P && !placed; p++){
            if(classCellEmpty(c,d,p) && teacherFreeAt(t,d,p)){
              place(c,s,d,p);
              left--; placed=true;
            }
          }
        }
        if(!placed) break; // try swapping next
      }
      needMap[c][s] = left;
    }
  }

  // 3) swap inside class if still needed (use an empty somewhere else in the same class)
  for(const c of CLASSES){
    for(const [s,left] of Object.entries(needMap[c]||{})){
      let need = left;
      if(need<=0) continue;
      const tNeed = teacherOf(c,s);
      // find any slot (d,p) currently occupied by some s2 where tNeed is free,
      // and there exists another empty slot (d2,p2) in the SAME class where s2's teacher is free.
      outer:
      while(need>0){
        let swapped=false;
        for(let d=0; d<D && !swapped; d++){
          for(let p=0; p<P && !swapped; p++){
            const cell = classSchedule[c][d][p];
            if(!cell) continue; // we need a filled cell to swap out from
            const s2 = cell.subject;
            const t2 = teacherOf(c,s2);
            if(!teacherFreeAt(tNeed,d,p)) continue;

            // find empty target for s2
            for(let d2=0; d2<D && !swapped; d2++){
              for(let p2=0; p2<P && !swapped; p2++){
                if(classCellEmpty(c,d2,p2) && teacherFreeAt(t2,d2,p2)){
                  // move s2 to empty
                  classSchedule[c][d][p]=null;
                  teacherSchedule[t2][d][p]=null;
                  place(c,s2,d2,p2);
                  // place s here
                  place(c,s,d,p);
                  need--; swapped=true;
                }
              }
            }
          }
        }
        if(!swapped) break outer; // nothing more we can do safely
      }
      needMap[c][s]=need;
    }
  }

  // 4) as a last resort, if any null remains, fill with FREE (should be none now)
  for(const c of CLASSES){
    for(let d=0; d<D; d++){
      for(let p=0; p<P; p++){
        if(!classSchedule[c][d][p]){
          classSchedule[c][d][p] = {subject:'FREE', teacher:''};
        }
      }
    }
  }
}

/* ---------- Full schedule build (now with relaxed + repair) ---------- */
function buildScheduleSmart(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;
  initGrids(D,P);

  const order = [...CLASSES].sort((a,b)=> totalForClass(b)-totalForClass(a));

  let unscheduled = [];

  for(const cls of order){
    const plan = buildClassPlan(cls, D, P);
    for(let d=0; d<D; d++){
      for(let p=0; p<P; p++){
        const s = plan[d][p];
        if(!s) continue;

        const target = WEEKLY[cls]?.[s]||0;
        const currentCount = countPlacedForClassSubject(cls, s);
        if(currentCount >= target) continue;

        const t = teacherOf(cls, s);
        if(!t) { unscheduled.push({cls, subject:s, reason:'No teacher assigned'}); continue; }

        // PASS 1: normal (respect run + clash)
        let placed=false;
        const trySlots = [p, ...range(P).filter(pp=>pp!==p)];
        for(const pp of trySlots){
          if(classSchedule[cls][d][pp]) continue;
          if(violatesRun(cls,d,pp,s)) continue;
          if(teacherSchedule[t][d][pp] || !teacherAvailable(t,d)) continue;
          place(cls,s,d,pp);
          placed=true; break;
        }

        // PASS 2: relaxed (ignore run; still avoid teacher clash)
        if(!placed){
          for(let dd=0; dd<D && !placed; dd++){
            for(let pp=0; pp<P && !placed; pp++){
              if(classSchedule[cls][dd][pp]) continue;
              if(teacherSchedule[t][dd][pp] || !teacherAvailable(t,dd)) continue;
              place(cls,s,dd,pp);
              placed=true;
            }
          }
        }

        if(!placed){
          unscheduled.push({cls, subject:s, reason:'No free slot without clash'});
        }
      }
    }
  }

  // Repair to guarantee no empties & exact counts
  repairToNoEmpty();

  return {unscheduled};
}

/* ---------- RENDER TIMETABLES ---------- */
function renderClassTables(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;
  let html = '';
  CLASSES.forEach(c=>{
    html += `<h4>Class ${c}</h4><div class="scroll"><table><thead><tr><th>Day\\Period</th>`;
    for(let p=0;p<P;p++) html+=`<th>P${p+1}</th>`;
    html+='</tr></thead><tbody>';
    for(let d=0; d<D; d++){
      html += `<tr><td>Day ${d+1}</td>`;
      for(let p=0; p<P; p++){
        const cell = classSchedule[c][d][p];
        const txt = cell.subject==='FREE' ? 'FREE' : `${cell.subject}<br><span class="muted">${cell.teacher}</span>`;
        html += `<td>${txt}</td>`;
      }
      html+='</tr>';
    }
    html+='</tbody></table></div>';
  });
  $("classTT").innerHTML = html || '<div class="muted">No data.</div>';
}

function renderTeacherTables(){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;
  let html = '';
  TEACHERS.forEach(t=>{
    html += `<h4>${t}</h4><div class="scroll"><table><thead><tr><th>Day\\Period</th>`;
    for(let p=0;p<P;p++) html+=`<th>P${p+1}</th>`;
    html+='</tr></thead><tbody>';
    for(let d=0; d<D; d++){
      html += `<tr><td>Day ${d+1}</td>`;
      for(let p=0; p<P; p++){
        const cell = teacherSchedule[t][d][p];
        const txt = cell ? `${cell.cls}<br><span class="muted">${cell.subject}</span>` : '';
        html += `<td>${txt}</td>`;
      }
      html+='</tr>';
    }
    html+='</tbody></table></div>';
  });
  $("teacherTT").innerHTML = html || '<div class="muted">No data.</div>';
}

/* ---------- EXCEL EXPORT (separate sheets) ---------- */
function toSheetClass(cls){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;
  const aoa = [[`Class ${cls}`],["Day/Period", ...range(P).map(i=>`P${i+1}`)]];
  for(let d=0; d<D; d++){
    const row = [`Day ${d+1}`];
    for(let p=0;p<P;p++){
      const cell = classSchedule[cls]?.[d]?.[p];
      row.push(cell ? (cell.subject==='FREE' ? 'FREE' : `${cell.subject} (${cell.teacher})`) : "");
    }
    aoa.push(row);
  }
  return XLSX.utils.aoa_to_sheet(aoa);
}
function toSheetTeacher(t){
  const P=+$("periodsPerDay").value||0, D=+$("workingDays").value||0;
  const aoa = [[`Teacher ${t}`],["Day/Period", ...range(P).map(i=>`P${i+1}`)]];
  for(let d=0; d<D; d++){
    const row = [`Day ${d+1}`];
    for(let p=0;p<P;p++){
      const cell = teacherSchedule[t]?.[d]?.[p];
      row.push(cell ? `${cell.cls} (${cell.subject})` : "");
    }
    aoa.push(row);
  }
  return XLSX.utils.aoa_to_sheet(aoa);
}
function downloadClasswiseExcel(){
  if(Object.keys(classSchedule).length===0){ alert("Please click Generate first."); return; }
  const wb = XLSX.utils.book_new();
  CLASSES.forEach(c=>{
    const ws = toSheetClass(c);
    XLSX.utils.book_append_sheet(wb, ws, safeSheetName(c));
  });
  XLSX.writeFile(wb,"Classwise_Timetable.xlsx");
}
function downloadTeacherwiseExcel(){
  if(Object.keys(teacherSchedule).length===0){ alert("Please click Generate first."); return; }
  const wb = XLSX.utils.book_new();
  TEACHERS.forEach(t=>{
    const ws = toSheetTeacher(t);
    XLSX.utils.book_append_sheet(wb, ws, safeSheetName(t));
  });
  XLSX.writeFile(wb,"Teacherwise_Timetable.xlsx");
}
function safeSheetName(n){ return String(n).slice(0,31).replace(/[:\\/?*\[\]]/g,'-'); }

/* ---------- GENERATE ---------- */
function generateTimetable(){
  $("warnBox").style.display='none'; $("okBox").style.display='none';

  saveWeeklyPeriods(); // capture matrix values

  const v = validateAll();
  if(!v.ok){
    $("warnBox").style.display='block';
    $("warnBox").textContent = v.msg;
    $("classTT").innerHTML=""; $("teacherTT").innerHTML="";
    return;
  }

  const {unscheduled} = buildScheduleSmart();

  // Check for any FREE left (should be none with repair)
  const hasFree = Object.values(classSchedule).some(grid =>
    grid.flat().some(cell => cell && cell.subject==='FREE')
  );

  if(unscheduled.length || hasFree){
    $("warnBox").style.display='block';
    $("warnBox").innerHTML = `<b>Warning</b><br>Schedule created with soft constraints relaxed in a few places to avoid empty classes. All weekly counts are satisfied, no teacher clashes.`;
  }else{
    $("okBox").style.display='block';
    $("okBox").textContent = "Timetable generated successfully. No clashes. Max 2 consecutive per subject avoided where possible. P1 given to class incharge when possible. No empty class slots.";
  }

  renderClassTables();
  renderTeacherTables();
}

/* ---------- INIT ---------- */
function init(){
  renderTeachers(); renderClasses(); renderSubjects(); renderAssign(); renderIncharge();
  updateSelectors(); renderMatrix(); updateTeacherLoad(); calcSlotsPill();
}
$("periodsPerDay").addEventListener('input', ()=>{ calcSlotsPill(); showMatrixInfo(); updateTeacherLoad(); });
$("workingDays").addEventListener('input', ()=>{ calcSlotsPill(); showMatrixInfo(); updateTeacherLoad(); });
init();
</script>

<script>
// Add this outside the init() function

document.getElementById('jsonUpload').addEventListener('change', function(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      loadFromJson(data);
    } catch (err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
});

function loadFromJson(data) {
  $("periodsPerDay").value = data.settings.periods_per_day || 8;
  $("workingDays").value = data.settings.working_days || 6;

  TEACHERS = [];
  AVAIL = {};
  for (const [name, days] of Object.entries(data.teachers || {})) {
    TEACHERS.push(name);
    AVAIL[name] = days.map(d => ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(d));
  }

  CLASSES = [...(data.classes || [])];
  SUBJECTS = [...(data.subjects || [])];
  ASSIGN = [...(data.assignments || [])];
  WEEKLY = JSON.parse(JSON.stringify(data.weekly || {}));
  INCHARGE = {...(data.incharge || {})};

  renderTeachers();
  renderClasses();
  renderSubjects();
  renderAssign();
  renderIncharge();
  updateSelectors();
  renderMatrix();
  updateTeacherLoad();
  calcSlotsPill();
  showMatrixInfo();
}

/* ---------- DOWNLOAD LATEST JSON ---------- */
function downloadJson(){
  // preserve current weekly matrix before export
  saveWeeklyPeriods();

  const settings = {
    periods_per_day: +$("periodsPerDay").value || 8,
    working_days: +$("workingDays").value || 6
  };

  const teachers = {};
  TEACHERS.forEach(t=>{
    const idxs = (AVAIL[t]||[]);
    const names = idxs.length ? idxs.map(i=> ["Mon","Tue","Wed","Thu","Fri","Sat"][i]) : ["Mon","Tue","Wed","Thu","Fri","Sat"].slice(0, settings.working_days);
    teachers[t] = names;
  });

  const data = {
    settings,
    teachers,
    classes: CLASSES,
    subjects: SUBJECTS,
    assignments: ASSIGN,
    weekly: WEEKLY,
    incharge: INCHARGE
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "latest_timetable.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

</script>


</body>
</html>
